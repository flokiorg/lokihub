package lnd

import (
	"crypto/x509"
	"encoding/hex"
	"encoding/pem"
	"testing"
)

func TestDebugCertParsing(t *testing.T) {
	// The hex string provided by the user
	certHex := "2d2d2d2d2d424547494e2043455254494649434154452d2d2d2d2d0a4d4949435944434341676167417749424167495166557147374d4532396736314a56665341794679316a414b42676771686b6a4f50515144416a41764d5238770a485159445651514b45785a73626d5167595856306232646c626d56795958526c5a43426a5a584a304d517777436759445651514445774e73595749774868634e0a4d6a55784d6a45324d6a49314e6a41785768634e4d6a63774d6a45774d6a49314e6a4178576a41764d523877485159445651514b45785a73626d5167595856300a6232646c626d56795958526c5a43426a5a584a304d517777436759445651514445774e73595749775754415442676371686b6a4f5051494242676771686b6a4f0a50514d4242774e4341415252756a4938365379646741765052417a39416e376d47754a4c5968376f676779376b534454735836524356626f7a796f32703553720a78316961346778442f387643627034597977584d3538487963623747577478656f344942416a43422f7a414f42674e56485138424166384542414d43417151770a457759445652306c42417777436759466734736f58764e2b774d595071477a4d314a55776761634741315564455153426e7a43426e4949446247466967676c7362324e68624768760a6333534343577876593246736147397a64494945645735706549494b64573570654842685932746c64494948596e566d59323975626f634566774141415963510a41414141414141414141414141414141414141414159634577386e724c6f6345724245414159634572424941415963512f6f4141414141414141435541414c2f0a2f7664536a3463512f6f414141414141414141415171582f2f744257385963512f6f41414141414141414141516a332f2f6e6a3547346345414141414144414b0a42676771686b6a4f5051514441674e49414442464169414474773268475378565543322b6e41444a4558787058382b563774694e68374f7a3334666b735541570a51514968414a2f787556754e6c65766b5045374c502b7770734f734f30433355302f6d4e71526e4d2f347065696245790a2d2d2d2d2d454e442043455254494649434154452d2d2d2d2d0a"

	certBytes, err := hex.DecodeString(certHex)
	if err != nil {
		t.Fatalf("Failed to decode hex: %v", err)
	}

	// 1. Try decoding PEM block
	block, rest := pem.Decode(certBytes)
	if block == nil {
		t.Logf("PEM Decode failed. Bytes:\n%s", string(certBytes))
		t.Fatal("Detailed error: pem.Decode returned nil block. Check if headers (-----BEGIN...) are correct.")
	}

	t.Logf("Found PEM Block Type: %s", block.Type)
	t.Logf("Rest bytes len: %d", len(rest))

	// 2. Try validating cert from ASN.1
	_, err = x509.ParseCertificate(block.Bytes)
	if err != nil {
		t.Fatalf("x509.ParseCertificate failed: %v", err)
	}
	t.Log("x509.ParseCertificate success")

	// 3. Try AppendCertsFromPEM (which is what fails in actual code)
	cp := x509.NewCertPool()
	if !cp.AppendCertsFromPEM(certBytes) {
		t.Fatal("AppendCertsFromPEM returned false (this reproduces the error)")
	}
	t.Log("AppendCertsFromPEM success")
}
